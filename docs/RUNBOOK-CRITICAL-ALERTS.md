# Critical Alerts Runbook

## Overview

This runbook provides step-by-step procedures for responding to critical alerts generated by Time8's seat management and billing system. All critical alerts are sent via Slack (if configured) and email to admin addresses.

**Response Time SLA**: Critical alerts should be acknowledged within 1 hour and resolved within 4 hours during business hours.

---

## Alert Types

### 1. Billing Discrepancy Alert

**Alert Name**: `billing_discrepancy`
**Severity**: `critical`
**Source**: Daily reconciliation job (runs at 3 AM)

#### What It Means
The database seat count doesn't match the Lemon Squeezy subscription quantity. This could lead to:
- Undercharging customers (lost revenue)
- Overcharging customers (trust issues, chargebacks)

#### Example Alert Message
```
ðŸš¨ CRITICAL: Billing discrepancy detected

Organization: Acme Corp (org_123abc)
Database seats: 12
Lemon Squeezy seats: 10
Difference: +2 seats

Action required: Investigate and resolve immediately
```

#### Response Procedure

**Step 1: Verify the Alert (5 min)**

1. Access Supabase dashboard â†’ Tables â†’ `alerts`
2. Find the alert record with `severity='critical'` and `alert_type='billing_discrepancy'`
3. Note the `organization_id` and `metadata` (contains discrepancy details)

**Step 2: Check Database State (5 min)**

```sql
-- Run this query in Supabase SQL Editor
SELECT
  s.id as subscription_id,
  s.current_seats,
  s.pending_seats,
  s.lemonsqueezy_subscription_id,
  s.lemonsqueezy_quantity_synced,
  s.renews_at,
  COUNT(CASE WHEN uo.status = 'active' THEN 1 END) as active_users,
  COUNT(CASE WHEN uo.status = 'pending_removal' THEN 1 END) as pending_removal_users
FROM subscriptions s
LEFT JOIN user_organizations uo ON uo.organization_id = s.organization_id
WHERE s.organization_id = 'org_123abc'  -- Replace with actual org ID
GROUP BY s.id;
```

**Expected Results:**
- `current_seats` should match `active_users` + `pending_removal_users`
- `lemonsqueezy_quantity_synced` should be `true` if no pending changes

**Step 3: Check Lemon Squeezy (5 min)**

1. Log into Lemon Squeezy dashboard
2. Navigate to Subscriptions â†’ Search by subscription ID
3. Note the current `quantity` value
4. Check recent subscription updates in activity log

**Step 4: Identify Root Cause (10 min)**

Common scenarios:

| Database > LS | Database < LS | Reason |
|---------------|---------------|---------|
| âœ“ | | Cron job failed to update LS before renewal |
| âœ“ | | Webhook `subscription_payment_success` not processed |
| | âœ“ | Manual change in LS dashboard |
| | âœ“ | Webhook processed but DB update failed |

**Step 5: Resolution (15 min)**

**Scenario A: Database is Correct, LS is Wrong**

```sql
-- Verify current active users
SELECT user_id, email, status
FROM user_organizations uo
JOIN profiles p ON p.id = uo.user_id
WHERE uo.organization_id = 'org_123abc'
AND uo.status IN ('active', 'pending_removal')
ORDER BY uo.status, p.email;
```

Then manually update Lemon Squeezy:
1. Go to Subscription details in LS dashboard
2. Click "Edit subscription"
3. Update quantity to match database active users
4. Save changes
5. Mark alert as resolved in database

**Scenario B: Lemon Squeezy is Correct, Database is Wrong**

```sql
-- Update database to match LS
UPDATE subscriptions
SET
  current_seats = 10,  -- Use LS quantity
  lemonsqueezy_quantity_synced = true,
  updated_at = NOW()
WHERE organization_id = 'org_123abc';
```

**Step 6: Mark Alert as Resolved (2 min)**

```sql
UPDATE alerts
SET
  resolved_at = NOW(),
  status = 'resolved'
WHERE id = 'alert_id_here';
```

**Step 7: Monitor for Recurrence (24 hours)**

- Check if same organization triggers another alert in next 24h
- If yes, investigate deeper (background jobs, webhook delivery, etc.)

---

### 2. Failed Subscription Update

**Alert Name**: `failed_subscription_update`
**Severity**: `critical`
**Source**: ApplyPendingSubscriptionChangesJob (runs every 6 hours)

#### What It Means
The system tried to update a Lemon Squeezy subscription quantity but the API call failed after 3 retry attempts.

#### Example Alert Message
```
ðŸš¨ CRITICAL: Failed to update subscription

Organization: Beta Inc (org_456def)
Subscription ID: sub_789ghi
Attempted quantity: 8
Error: API rate limit exceeded

Action required: Manual update needed before renewal
```

#### Response Procedure

**Step 1: Check Subscription Renewal Date (2 min)**

```sql
SELECT
  organization_id,
  renews_at,
  current_seats,
  pending_seats,
  lemonsqueezy_subscription_id
FROM subscriptions
WHERE organization_id = 'org_456def';
```

**Urgency Assessment:**
- **< 24 hours until renewal**: URGENT - Manual intervention required immediately
- **24-48 hours until renewal**: HIGH - Retry job or manual update within 4 hours
- **> 48 hours until renewal**: MEDIUM - Can wait for next job run (6 hours)

**Step 2: Check Lemon Squeezy API Status (2 min)**

1. Visit https://status.lemonsqueezy.com
2. Check for ongoing incidents or maintenance
3. If API is down, wait for recovery and retry

**Step 3: Manual Update (if < 48h until renewal) (10 min)**

```bash
# Use the Lemon Squeezy API directly
curl -X PATCH \
  https://api.lemonsqueezy.com/v1/subscription-items/{subscription_item_id} \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "type": "subscription-items",
      "id": "{subscription_item_id}",
      "attributes": {
        "quantity": 8
      }
    }
  }'
```

Or use the admin API endpoint:
```bash
# Via Time8 API (requires admin auth)
curl -X POST \
  https://time8.io/api/admin/force-subscription-sync \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "organizationId": "org_456def",
    "targetQuantity": 8
  }'
```

**Step 4: Verify Update (2 min)**

1. Check Lemon Squeezy dashboard - quantity should now be 8
2. Update database:

```sql
UPDATE subscriptions
SET lemonsqueezy_quantity_synced = true
WHERE organization_id = 'org_456def';
```

**Step 5: Mark Alert as Resolved (2 min)**

```sql
UPDATE alerts
SET
  resolved_at = NOW(),
  status = 'resolved',
  resolution_notes = 'Manually updated subscription quantity via LS API'
WHERE id = 'alert_id_here';
```

---

### 3. Webhook Processing Failure

**Alert Name**: `webhook_processing_failed`
**Severity**: `critical`
**Source**: Lemon Squeezy webhook handler

#### What It Means
A critical webhook event (`subscription_payment_success`) failed to process, meaning users weren't archived and seat counts weren't updated at renewal.

#### Example Alert Message
```
ðŸš¨ CRITICAL: Webhook processing failed

Event: subscription_payment_success
Event ID: evt_abc123
Organization: Gamma LLC (org_789jkl)
Error: Database update failed - foreign key constraint

Action required: Manual archival and seat update needed
```

#### Response Procedure

**Step 1: Check Event Processing Status (5 min)**

```sql
SELECT * FROM billing_events
WHERE event_id = 'evt_abc123'
ORDER BY created_at DESC
LIMIT 5;
```

**Step 2: Identify Pending Removals (5 min)**

```sql
SELECT
  uo.user_id,
  p.email,
  p.full_name,
  uo.removal_effective_date,
  uo.status
FROM user_organizations uo
JOIN profiles p ON p.id = uo.user_id
WHERE uo.organization_id = 'org_789jkl'
AND uo.status = 'pending_removal'
AND uo.removal_effective_date IS NOT NULL
AND uo.removal_effective_date <= NOW();
```

**Step 3: Manual Archival (10 min)**

```sql
-- Archive users with expired grace periods
UPDATE user_organizations
SET
  status = 'archived',
  is_active = false,
  removal_effective_date = NULL,
  updated_at = NOW()
WHERE organization_id = 'org_789jkl'
AND status = 'pending_removal'
AND removal_effective_date IS NOT NULL
AND removal_effective_date <= NOW();

-- Update subscription
UPDATE subscriptions
SET
  current_seats = pending_seats,
  pending_seats = NULL,
  lemonsqueezy_quantity_synced = true,
  updated_at = NOW()
WHERE organization_id = 'org_789jkl';
```

**Step 4: Verify Archival (2 min)**

```sql
-- Should return 0 rows
SELECT * FROM user_organizations
WHERE organization_id = 'org_789jkl'
AND status = 'pending_removal'
AND removal_effective_date IS NOT NULL
AND removal_effective_date <= NOW();

-- Verify current_seats matches active users
SELECT
  s.current_seats,
  COUNT(uo.user_id) as active_count
FROM subscriptions s
LEFT JOIN user_organizations uo ON uo.organization_id = s.organization_id
WHERE s.organization_id = 'org_789jkl'
AND uo.status = 'active'
GROUP BY s.id, s.current_seats;
```

**Step 5: Mark Alert as Resolved (2 min)**

```sql
UPDATE alerts
SET
  resolved_at = NOW(),
  status = 'resolved',
  resolution_notes = 'Manually archived users and updated seat counts'
WHERE id = 'alert_id_here';
```

---

## Escalation Procedures

### When to Escalate

Escalate to senior developer/CTO if:
- Alert resolution exceeds 4 hours
- Root cause is unclear after 30 minutes of investigation
- Multiple organizations affected by same issue
- Database corruption suspected
- Lemon Squeezy API unavailable for > 2 hours
- Customer reports billing issue related to alert

### Escalation Contacts

1. **Primary On-Call**: Check Slack #time8-oncall channel
2. **CTO**: Szymon Rajca (szymon.rajca@bb8.pl)
3. **Lead Developer**: [Your name]
4. **Lemon Squeezy Support**: support@lemonsqueezy.com (for API issues)

---

## Prevention & Monitoring

### Daily Checks (5 min)

1. Review alerts table for unresolved critical alerts:
```sql
SELECT * FROM alerts
WHERE severity = 'critical'
AND resolved_at IS NULL
ORDER BY created_at DESC;
```

2. Check background job health:
```sql
SELECT * FROM billing_events
WHERE event_type IN ('apply_pending_changes', 'reconcile_subscriptions')
AND created_at > NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC;
```

### Weekly Review (30 min)

1. Analyze alert patterns:
```sql
SELECT
  alert_type,
  COUNT(*) as count,
  AVG(EXTRACT(EPOCH FROM (resolved_at - created_at))/60) as avg_resolution_minutes
FROM alerts
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY alert_type
ORDER BY count DESC;
```

2. Review webhook processing success rate:
```sql
SELECT
  event_type,
  COUNT(*) as total,
  SUM(CASE WHEN status = 'processed' THEN 1 ELSE 0 END) as successful,
  ROUND(100.0 * SUM(CASE WHEN status = 'processed' THEN 1 ELSE 0 END) / COUNT(*), 2) as success_rate
FROM billing_events
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY event_type;
```

---

## Troubleshooting Tools

### Useful SQL Queries

**Find all subscriptions with discrepancies:**
```sql
SELECT
  s.organization_id,
  o.name as org_name,
  s.current_seats,
  COUNT(uo.user_id) as actual_active,
  s.current_seats - COUNT(uo.user_id) as discrepancy
FROM subscriptions s
JOIN organizations o ON o.id = s.organization_id
LEFT JOIN user_organizations uo ON uo.organization_id = s.organization_id AND uo.status = 'active'
GROUP BY s.id, s.organization_id, o.name, s.current_seats
HAVING s.current_seats != COUNT(uo.user_id);
```

**Find subscriptions renewing in next 48 hours:**
```sql
SELECT
  organization_id,
  renews_at,
  current_seats,
  pending_seats,
  lemonsqueezy_quantity_synced
FROM subscriptions
WHERE renews_at BETWEEN NOW() AND NOW() + INTERVAL '48 hours'
AND status = 'active';
```

**Find users stuck in pending_removal past their effective date:**
```sql
SELECT
  uo.user_id,
  p.email,
  uo.organization_id,
  o.name as org_name,
  uo.removal_effective_date,
  NOW() - uo.removal_effective_date as overdue_by
FROM user_organizations uo
JOIN profiles p ON p.id = uo.user_id
JOIN organizations o ON o.id = uo.organization_id
WHERE uo.status = 'pending_removal'
AND uo.removal_effective_date IS NOT NULL
AND uo.removal_effective_date < NOW()
ORDER BY uo.removal_effective_date;
```

### Admin Dashboard

Access the admin dashboard at: `https://time8.io/admin/settings` (Billing tab)

**Key Indicators:**
- Red badge: Subscription quantity out of sync
- Yellow badge: Pending seat changes
- Green checkmark: All synced

---

## Post-Incident Review

After resolving a critical alert, conduct a brief post-mortem:

1. **Root Cause**: What caused the alert?
2. **Detection Time**: How long until alert was noticed?
3. **Resolution Time**: How long to fully resolve?
4. **Prevention**: What can prevent recurrence?
5. **Documentation**: Update this runbook if procedures were unclear

**Post-Mortem Template:**
```markdown
## Incident: [Alert Type] - [Date]

**Affected Organization:** [Org Name] (org_id)
**Alert Time:** YYYY-MM-DD HH:MM
**Acknowledged:** YYYY-MM-DD HH:MM (X minutes)
**Resolved:** YYYY-MM-DD HH:MM (X minutes)

**Root Cause:**
[Brief explanation]

**Resolution Steps:**
1. [What was done]
2. [What was done]

**Prevention:**
- [ ] [Action item 1]
- [ ] [Action item 2]

**Runbook Updates:**
- [ ] [Any clarifications needed]
```

---

## Contact Information

**Slack Channels:**
- `#time8-alerts` - Critical alert notifications
- `#time8-oncall` - On-call rotation and escalation
- `#time8-dev` - General development questions

**Email:**
- Critical alerts: `ADMIN_ALERT_EMAIL` (from .env)
- Lemon Squeezy support: support@lemonsqueezy.com
- Supabase support: support@supabase.com

**Documentation:**
- README: `/README.md`
- Environment Variables: `/.env.example`
- Deployment Checklist: `/docs/DEPLOYMENT-CHECKLIST.md`

---

*Last updated: 2025-11-05*
